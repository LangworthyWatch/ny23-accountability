{{ define "main" }}
<article class="pa3 pa4-ns nested-copy-line-height nested-links">
  <main class="cf ph3 ph5-l pv3 pv4-l f4 center mw8 lh-copy near-black">
    {{ .Content }}
  </main>

  <div class="ph3 ph5-l">
    <h2 class="f3 fw6 ttu tracked">Voting Record Database</h2>

    <!-- Debug info - remove after testing -->
    {{ if .Site.Data.votes }}
    <div class="pa2 bg-light-yellow">Debug: Data loaded - {{ len .Site.Data.votes }} votes found</div>
    {{ else }}
    <div class="pa2 bg-light-red">Debug: No data loaded from .Site.Data.votes</div>
    {{ end }}

    <!-- Search and Filter Section -->
    <div class="mb4 pa3 bg-near-white">
      <div class="mb3">
        <label for="search" class="db fw6 mb2">Search votes:</label>
        <input
          type="text"
          id="search"
          class="input-reset ba b--black-20 pa2 mb2 db w-100"
          placeholder="Search by bill number, description, or topic..."
        >
      </div>

      <div class="mb3">
        <label for="filter-vote" class="db fw6 mb2">Filter by vote:</label>
        <select id="filter-vote" class="pa2 input-reset ba b--black-20 bg-white">
          <option value="">All votes</option>
          <option value="Yea">Yea</option>
          <option value="Nay">Nay</option>
          <option value="Present">Present</option>
          <option value="Not Voting">Not Voting</option>
        </select>
      </div>

      <div class="mb3">
        <label for="filter-topic" class="db fw6 mb2">Filter by topic:</label>
        <select id="filter-topic" class="pa2 input-reset ba b--black-20 bg-white">
          <option value="">All topics</option>
          <option value="Healthcare">Healthcare</option>
          <option value="Immigration">Immigration</option>
          <option value="Veterans">Veterans</option>
          <option value="Budget">Budget & Appropriations</option>
          <option value="Defense">Defense</option>
          <option value="Agriculture">Agriculture</option>
          <option value="Education">Education</option>
          <option value="Energy">Energy</option>
          <option value="Environment">Environment</option>
        </select>
      </div>
    </div>

    <!-- Vote Statistics -->
    <div class="mb4 pa3 bg-light-blue">
      <h3 class="f4 fw6">Vote Summary</h3>
      <div class="cf">
        <div class="fl w-50 w-25-l pa2">
          <div class="fw6">Total Votes:</div>
          <div id="total-votes" class="f3">{{ if .Site.Data.votes }}{{ len .Site.Data.votes }}{{ else }}0{{ end }}</div>
        </div>
        <div class="fl w-50 w-25-l pa2">
          <div class="fw6">Yea:</div>
          <div id="yea-count" class="f3 green">-</div>
        </div>
        <div class="fl w-50 w-25-l pa2">
          <div class="fw6">Nay:</div>
          <div id="nay-count" class="f3 red">-</div>
        </div>
        <div class="fl w-50 w-25-l pa2">
          <div class="fw6">Other:</div>
          <div id="other-count" class="f3">-</div>
        </div>
      </div>
    </div>

    <!-- Votes Table -->
    <div class="overflow-auto">
      <table class="f6 w-100 mw8 center" cellspacing="0" id="votes-table">
        <thead>
          <tr class="stripe-dark">
            <th class="fw6 tl pa3 bg-white">Date</th>
            <th class="fw6 tl pa3 bg-white">Roll Call</th>
            <th class="fw6 tl pa3 bg-white">Bill</th>
            <th class="fw6 tl pa3 bg-white">Description</th>
            <th class="fw6 tc pa3 bg-white">Vote</th>
            <th class="fw6 tc pa3 bg-white">Result</th>
          </tr>
        </thead>
        <tbody class="lh-copy">
          {{ range .Site.Data.votes }}
          <tr class="stripe-dark vote-row"
              data-vote="{{ .vote }}"
              data-topic="{{ .topic | default "" }}"
              data-bill="{{ .bill | default "" }}"
              data-description="{{ .description | lower }}">
            <td class="pa3">{{ .date }}</td>
            <td class="pa3">
              <a href="{{ .url }}" target="_blank" class="link blue hover-bg-light-blue">
                #{{ .roll_call }}
              </a>
            </td>
            <td class="pa3">
              {{ with .bill }}
                <span class="fw6">{{ . }}</span>
                {{ with $.title }}<br><span class="f7 gray">{{ . }}</span>{{ end }}
              {{ else }}
                <span class="gray i">Procedural</span>
              {{ end }}
            </td>
            <td class="pa3 f6">
              {{ .description | truncate 120 }}
              {{ with .topic }}
                <br><span class="f7 fw6 blue">{{ . }}</span>
              {{ end }}
            </td>
            <td class="pa3 tc fw6 {{ if eq .vote "Yea" }}green{{ else if eq .vote "Nay" }}red{{ else }}gray{{ end }}">
              {{ .vote }}
            </td>
            <td class="pa3 tc f7">
              {{ if strings.Contains .result "Passed" }}
                <span class="green">✓ Passed</span>
              {{ else if strings.Contains .result "Failed" }}
                <span class="red">✗ Failed</span>
              {{ else }}
                {{ .result | truncate 30 }}
              {{ end }}
            </td>
          </tr>
          {{ end }}
        </tbody>
      </table>
    </div>

    <div id="no-results" class="dn pa4 tc bg-light-red">
      <p class="f4">No votes match your search criteria.</p>
    </div>
  </div>
</article>

<script>
// Client-side filtering and search
(function() {
  const searchInput = document.getElementById('search');
  const voteFilter = document.getElementById('filter-vote');
  const topicFilter = document.getElementById('filter-topic');
  const voteRows = document.querySelectorAll('.vote-row');
  const noResults = document.getElementById('no-results');

  // Calculate statistics
  function updateStats() {
    let yea = 0, nay = 0, other = 0;
    voteRows.forEach(row => {
      const vote = row.dataset.vote;
      if (vote === 'Yea') yea++;
      else if (vote === 'Nay') nay++;
      else other++;
    });
    document.getElementById('yea-count').textContent = yea;
    document.getElementById('nay-count').textContent = nay;
    document.getElementById('other-count').textContent = other;
  }

  updateStats();

  // Filter function
  function filterVotes() {
    const searchTerm = searchInput.value.toLowerCase();
    const voteValue = voteFilter.value;
    const topicValue = topicFilter.value;
    let visibleCount = 0;

    voteRows.forEach(row => {
      const matchesSearch = !searchTerm ||
        row.dataset.description.includes(searchTerm) ||
        row.dataset.bill.toLowerCase().includes(searchTerm);

      const matchesVote = !voteValue || row.dataset.vote === voteValue;
      const matchesTopic = !topicValue || row.dataset.topic === topicValue;

      if (matchesSearch && matchesVote && matchesTopic) {
        row.classList.remove('dn');
        visibleCount++;
      } else {
        row.classList.add('dn');
      }
    });

    // Show/hide no results message
    if (visibleCount === 0) {
      noResults.classList.remove('dn');
    } else {
      noResults.classList.add('dn');
    }
  }

  // Event listeners
  searchInput.addEventListener('input', filterVotes);
  voteFilter.addEventListener('change', filterVotes);
  topicFilter.addEventListener('change', filterVotes);
})();
</script>

{{ end }}
